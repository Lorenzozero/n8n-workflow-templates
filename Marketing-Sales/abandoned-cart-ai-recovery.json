{
  "meta": {
    "instanceId": "9a0b1c2d-3e4f-5a6b-7c8d-9e0f1a2b3c4d"
  },
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 30
            }
          ]
        }
      },
      "id": "0b1c2d3e-4f5a-6b7c-8d9e-0f1a2b3c4d5e",
      "name": "Check Carts Schedule",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [280, 300]
    },
    {
      "parameters": {
        "resource": "checkout",
        "operation": "getAll",
        "returnAll": true,
        "filters": {
          "status": "open",
          "updated_at_min": "={{ $now.minus({hours: 2}).toISO() }}"
        }
      },
      "id": "1c2d3e4f-5a6b-7c8d-9e0f-1a2b3c4d5e6f",
      "name": "Get Abandoned Carts",
      "type": "n8n-nodes-base.shopify",
      "typeVersion": 1,
      "position": [500, 300]
    },
    {
      "parameters": {
        "model": "gpt-4",
        "messages": {
          "messageValues": [
            {
              "role": "system",
              "message": "You are an e-commerce recovery specialist. Analyze abandoned cart data and create personalized recovery strategies with urgency tactics, product recommendations, and emotional triggers."
            },
            {
              "role": "user",
              "message": "=Create recovery strategy for cart: Products: {{ $json.line_items.map(item => item.title).join(', ') }}, Total: ${{ $json.total_price }}, Customer: {{ $json.customer?.first_name || 'Valued Customer' }}, Abandoned: {{ $now.diff($json.updated_at, 'hours') }} hours ago"
            }
          ]
        },
        "options": {
          "temperature": 0.7
        }
      },
      "id": "2d3e4f5a-6b7c-8d9e-0f1a-2b3c4d5e6f7a",
      "name": "AI Recovery Strategy",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [720, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "={{ $json.customer?.email }}",
            "operation": "isNotEmpty"
          }
        }
      },
      "id": "3e4f5a6b-7c8d-9e0f-1a2b-3c4d5e6f7a8b",
      "name": "Has Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [940, 300]
    },
    {
      "parameters": {
        "model": "dall-e-3",
        "prompt": "=Create an attractive product showcase image for: {{ $json.line_items[0]?.title }}. Style: modern, clean, e-commerce product photography with subtle urgency elements",
        "options": {
          "size": "1024x1024",
          "quality": "standard"
        }
      },
      "id": "4f5a6b7c-8d9e-0f1a-2b3c-4d5e6f7a8b9c",
      "name": "Generate Product Image",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [1160, 200]
    },
    {
      "parameters": {
        "model": "gpt-4",
        "messages": {
          "messageValues": [
            {
              "role": "system",
              "message": "Generate compelling HTML email for cart recovery. Include: personalized greeting, product showcase, scarcity/urgency, social proof, clear CTA. Use modern email design with mobile optimization."
            },
            {
              "role": "user",
              "message": "=Create recovery email using strategy: {{ $('AI Recovery Strategy').item.json.strategy }}. Customer: {{ $json.customer?.first_name }}, Products: {{ $json.line_items.map(item => item.title + ' - $' + item.price).join(', ') }}, Cart URL: {{ $json.abandoned_checkout_url }}"
            }
          ]
        }
      },
      "id": "5a6b7c8d-9e0f-1a2b-3c4d-5e6f7a8b9c0d",
      "name": "Generate Recovery Email",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [1160, 400]
    },
    {
      "parameters": {
        "fromEmail": "noreply@shop.com",
        "toEmail": "={{ $json.customer.email }}",
        "subject": "={{ $('AI Recovery Strategy').item.json.email_subject || 'Your cart is waiting for you! ⏰' }}",
        "emailType": "html",
        "message": "={{ $('Generate Recovery Email').item.json.html_content }}",
        "attachments": {
          "attachments": [
            {
              "type": "url",
              "url": "={{ $('Generate Product Image').item.json.url }}",
              "name": "product-showcase.png"
            }
          ]
        }
      },
      "id": "6b7c8d9e-0f1a-2b3c-4d5e-6f7a8b9c0d1e",
      "name": "Send Recovery Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1380, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.whatsapp.com/send",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $json.customer?.phone }}"
            },
            {
              "name": "message",
              "value": "=Hi {{ $json.customer?.first_name }}! 👋 Your {{ $json.line_items[0]?.title }} is still in your cart. Complete your purchase in the next hour and get 15% off with code SAVE15! 🛍️ {{ $json.abandoned_checkout_url }}"
            }
          ]
        }
      },
      "id": "7c8d9e0f-1a2b-3c4d-5e6f-7a8b9c0d1e2f",
      "name": "WhatsApp Follow-up",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1160, 600]
    },
    {
      "parameters": {
        "base": { "baseId": "appXXXXXXXXXXXXXX" },
        "table": { "tableId": "tblXXXXXXXXXXXXXX" },
        "columns": {
          "mappingMode": "defineBelow",
          "values": {
            "Customer Email": "={{ $json.customer?.email }}",
            "Cart Value": "={{ $json.total_price }}",
            "Products": "={{ $json.line_items.map(item => item.title).join(', ') }}",
            "Recovery Strategy": "={{ $('AI Recovery Strategy').item.json.strategy_type }}",
            "Email Sent": "Yes",
            "Timestamp": "={{ $now.toISO() }}",
            "Status": "Recovery Initiated"
          }
        }
      },
      "id": "8d9e0f1a-2b3c-4d5e-6f7a-8b9c0d1e2f3a",
      "name": "Track Recovery Campaign",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [1600, 300]
    }
  ],
  "connections": {
    "Check Carts Schedule": {
      "main": [[
        {
          "node": "Get Abandoned Carts",
          "type": "main",
          "index": 0
        }
      ]]
    },
    "Get Abandoned Carts": {
      "main": [[
        {
          "node": "AI Recovery Strategy",
          "type": "main",
          "index": 0
        }
      ]]
    },
    "AI Recovery Strategy": {
      "main": [[
        {
          "node": "Has Email?",
          "type": "main",
          "index": 0
        }
      ]]
    },
    "Has Email?": {
      "main": [
        [
          {
            "node": "Generate Product Image",
            "type": "main",
            "index": 0
          },
          {
            "node": "Generate Recovery Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "WhatsApp Follow-up",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Generate Product Image": {
      "main": [[
        {
          "node": "Send Recovery Email",
          "type": "main",
          "index": 0
        }
      ]]
    },
    "Generate Recovery Email": {
      "main": [[
        {
          "node": "Send Recovery Email",
          "type": "main",
          "index": 0
        }
      ]]
    },
    "Send Recovery Email": {
      "main": [[
        {
          "node": "Track Recovery Campaign",
          "type": "main",
          "index": 0
        }
      ]]
    }
  }
}